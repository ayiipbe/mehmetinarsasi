<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mehmetâ€™in ArsasÄ± â€” GÃ¼ncel DeÄŸer</title>
  <style>
    :root{
      --bg:#0b0f14; --card:#111826; --card2:#0e1522; --border:#1d2a3d;
      --text:#e8eef6; --muted:#9aa8c7; --blue:#2b5cff;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    body{margin:0;background:var(--bg);color:var(--text)}
    .wrap{max-width:760px;margin:0 auto;padding:26px 16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:20px}
    h1{margin:0 0 8px;font-size:22px}
    .sub{color:var(--muted);font-size:13px;line-height:1.45}
    .hero{margin-top:14px;background:var(--card2);border:1px solid var(--border);border-radius:16px;padding:16px}
    .k{color:var(--muted);font-size:12px}
    .v{font-size:34px;font-weight:900;margin:6px 0 0}
    .mini{color:var(--muted);font-size:12px;margin-top:6px}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    button{cursor:pointer;border:0;border-radius:12px;padding:10px 12px;font-weight:800}
    .btn{background:var(--blue);color:#fff}
    .btn2{background:transparent;color:var(--text);border:1px solid var(--border)}
    .foot{margin-top:12px;color:var(--muted);font-size:12px}
    code{background:var(--card2);border:1px solid var(--border);padding:2px 6px;border-radius:8px}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1>Mehmetâ€™in arsasÄ±: â€œBugÃ¼n kaÃ§ para?â€ ğŸ˜„</h1>
      <div class="sub">
        2018â€™de â€œ75.000 TL verdimâ€ demek kolayâ€¦<br>
        Biz iÅŸi romantizmden Ã§Ä±karÄ±p <b>468 gram altÄ±n</b> Ã¼zerinden konuÅŸuyoruz.
      </div>

      <div class="hero">
        <div class="k" id="status">Veri Ã§ekiliyorâ€¦</div>
        <div class="v" id="value">â€”</div>
        <div class="mini" id="detail">â€”</div>
      </div>

      <div class="row">
        <button class="btn" id="share">WhatsAppâ€™ta paylaÅŸ</button>
        <button class="btn2" id="refresh">Yenile</button>
      </div>

      <div class="foot" id="debug"></div>
    </div>
  </div>

<script>
  // SENÄ°N Ä°STEDÄ°ÄÄ°N: tek deÄŸer = 468 gramÄ±n TL karÅŸÄ±lÄ±ÄŸÄ±
  const GRAM = 468;

  // CORS'a takÄ±lmamak iÃ§in Ã¶nce aynÄ± domaindeki data.json'Ä± deniyoruz:
  const LOCAL = "./data.json?ts=" + Date.now();

  // Olursa uzaktan da dener (bazÄ± tarayÄ±cÄ±larda Ã§alÄ±ÅŸÄ±r, bazÄ±larÄ±nda CORS engeller):
  const REMOTE = "https://finans.truncgil.com/v4/today.json";

  const elStatus = document.getElementById("status");
  const elValue  = document.getElementById("value");
  const elDetail = document.getElementById("detail");
  const elDebug  = document.getElementById("debug");

  function parseTRNumber(x){
    if (typeof x !== "string") return Number(x);
    const cleaned = x.replace(/\./g,"").replace(",",".");
    const n = Number(cleaned);
    return Number.isFinite(n) ? n : NaN;
  }

  function fmtTRY(n){
    return n.toLocaleString("tr-TR", { style:"currency", currency:"TRY", maximumFractionDigits:2 });
  }

  function pickGramPrice(data){
    // "gram-altin" varsa direkt al, yoksa iÃ§inde "gram" geÃ§en ilk fiyat objesini bul.
    const direct = data["gram-altin"];
    if (direct && (direct.Selling || direct.Buying)) {
      const p = parseTRNumber(String(direct.Selling || direct.Buying));
      if (Number.isFinite(p)) return { price: p, update: data.Update_Date || "" };
    }

    const entries = Object.entries(data).filter(([k,v]) =>
      v && typeof v === "object" && (("Selling" in v) || ("Buying" in v))
    );

    const hit = entries.find(([k]) => k.toLowerCase().includes("gram")) || entries[0];
    if (!hit) return null;

    const obj = hit[1];
    const p = parseTRNumber(String(obj.Selling || obj.Buying));
    if (!Number.isFinite(p)) return null;

    return { price: p, update: data.Update_Date || "" };
  }

  async function fetchJson(url){
    const r = await fetch(url, { cache:"no-store" });
    if (!r.ok) throw new Error("HTTP " + r.status + " @ " + url);
    return r.json();
  }

  function setUI(price, update, sourceLabel){
    const total = price * GRAM;

    elStatus.textContent = "ArsanÄ±n gÃ¼ncel deÄŸeri (468 g altÄ±n)";
    elValue.textContent  = fmtTRY(total);

    const upd = update ? ("GÃ¼ncelleme: " + update) : ("GÃ¼ncelleme: " + new Date().toLocaleString("tr-TR"));
    elDetail.textContent = `1 g = ${fmtTRY(price)} â€¢ ${upd} â€¢ Kaynak: ${sourceLabel}`;

    // DÃ¼nkÃ¼ tadÄ±nda kÄ±sa espri
    elDebug.textContent =
      `KÄ±sacasÄ±: â€œ75 bin TLâ€ gÃ¼zel hikÃ¢yeâ€¦ ama bugÃ¼n altÄ±n konuÅŸuyor ğŸ™‚`;
  }

  async function load(){
    elStatus.textContent = "Veri Ã§ekiliyorâ€¦";
    elValue.textContent = "â€”";
    elDetail.textContent = "â€”";
    elDebug.textContent = "";

    // 1) Local (CORS yok)
    try{
      const d = await fetchJson(LOCAL);
      const picked = pickGramPrice(d);
      if (!picked) throw new Error("data.json iÃ§inde uygun fiyat bulunamadÄ±");
      setUI(picked.price, picked.update, "repo/data.json");
      return;
    }catch(e1){
      // 2) Remote (olursa)
      try{
        const d2 = await fetchJson(REMOTE);
        const picked2 = pickGramPrice(d2);
        if (!picked2) throw new Error("remote JSON iÃ§inde uygun fiyat bulunamadÄ±");
        setUI(picked2.price, picked2.update, "finans.truncgil.com");
        return;
      }catch(e2){
        elStatus.textContent = "Veri alÄ±namadÄ±.";
        elDetail.textContent = "Muhtemel sebep: CORS/eriÅŸim engeli. Ã‡Ã¶zÃ¼m: repoâ€™ya data.json Ã¼reten Actions eklemek.";
        elDebug.innerHTML =
          `Åu an <code>data.json</code> yoksa bu normal. Ä°stersen sana tek dosyalÄ±k GitHub Actions workflowâ€™u veriyorum (altta).`;
      }
    }
  }

  document.getElementById("refresh").addEventListener("click", load);

  document.getElementById("share").addEventListener("click", () => {
    const msg =
      `Mehmetâ€™in arsasÄ± â€” 468 gram altÄ±n hesabÄ± (gÃ¼ncel):\n` +
      `${location.href}`;
    window.open("https://wa.me/?text=" + encodeURIComponent(msg), "_blank");
  });

  load();
</script>
</body>
</html>
