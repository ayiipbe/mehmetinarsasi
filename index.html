<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mehmetâ€™in ArsasÄ± â€” GÃ¼ncel DeÄŸer</title>

  <style>
    :root{
      --bg:#0b0f14; --card:#111826; --card2:#0e1522; --border:#1d2a3d;
      --text:#e8eef6; --muted:#9aa8c7; --blue:#2b5cff;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    body{margin:0;background:var(--bg);color:var(--text)}
    .wrap{max-width:760px;margin:0 auto;padding:26px 16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:20px}
    h1{margin:0 0 8px;font-size:22px}
    .sub{color:var(--muted);font-size:13px;line-height:1.45}
    .hero{margin-top:14px;background:var(--card2);border:1px solid var(--border);border-radius:16px;padding:16px}
    .k{color:var(--muted);font-size:12px}
    .v{font-size:36px;font-weight:900;margin:6px 0 0}
    .mini{color:var(--muted);font-size:12px;margin-top:6px;line-height:1.4}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    button{cursor:pointer;border:0;border-radius:12px;padding:10px 12px;font-weight:800}
    .btn{background:var(--blue);color:#fff}
    .btn2{background:transparent;color:var(--text);border:1px solid var(--border)}
    code{background:var(--card2);border:1px solid var(--border);padding:2px 6px;border-radius:8px}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1>Mehmetâ€™in arsasÄ±: â€œBugÃ¼n kaÃ§ para?â€ ğŸ˜„</h1>
      <div class="sub">
        2018â€™de â€œ75.000 TL verdimâ€ demek kolayâ€¦<br>
        Biz iÅŸi romantizmden Ã§Ä±karÄ±p <b>468 gram altÄ±n</b> Ã¼zerinden konuÅŸuyoruz.
      </div>

      <div class="hero">
        <div class="k" id="status">Veri Ã§ekiliyorâ€¦</div>
        <div class="v" id="value">â€”</div>
        <div class="mini" id="detail">â€”</div>
      </div>

      <div class="row">
        <button class="btn" id="share">WhatsAppâ€™ta paylaÅŸ</button>
        <button class="btn2" id="refresh">Yenile</button>
      </div>

      <div class="mini" id="quip" style="margin-top:10px"></div>
      <div class="mini" id="debug" style="margin-top:6px"></div>
    </div>
  </div>

<script>
  const GRAM_ADET = 468;
  const DATA_URL = "./data.json?ts=" + Date.now();
  const TARGET_NAME = "GRAMALTIN";

  const elStatus = document.getElementById("status");
  const elValue  = document.getElementById("value");
  const elDetail = document.getElementById("detail");
  const elQuip   = document.getElementById("quip");
  const elDebug  = document.getElementById("debug");

  function fmtTRY(n){
    return n.toLocaleString("tr-TR", { style:"currency", currency:"TRY", maximumFractionDigits:2 });
  }

  function parseSmart(x){
    // Kabul: number, "7067.02", "7.067,02"
    if (typeof x === "number") return x;
    if (typeof x !== "string") return NaN;

    const s = x.trim();

    // VirgÃ¼l varsa TR format varsay: 7.067,02 -> 7067.02
    if (s.includes(",")) {
      const tr = s.replace(/\./g, "").replace(",", ".");
      const n = Number(tr);
      return Number.isFinite(n) ? n : NaN;
    }

    // VirgÃ¼l yoksa nokta ondalÄ±ktÄ±r: 7067.02 -> 7067.02 (NOKTAYI SÄ°LME!)
    const n = Number(s);
    return Number.isFinite(n) ? n : NaN;
  }

  function normalize(p){
    // 436000 gibi uÃ§uksa genelde *100 hatasÄ±dÄ±r
    if (!Number.isFinite(p)) return p;
    if (p > 50000) p = p / 100;
    if (p > 50000) p = p / 100;
    return p;
  }

  function findGramAltin(data){
    // data.json iÃ§inde Name:"GRAMALTIN" olan kaydÄ± bul
    const upper = TARGET_NAME.toUpperCase();
    for (const [k, v] of Object.entries(data)) {
      if (!v || typeof v !== "object") continue;
      if (String(v.Name || "").toUpperCase() === upper) {
        return { key: k, item: v };
      }
    }
    // Alternatif: direkt key varsa
    if (data[TARGET_NAME] && typeof data[TARGET_NAME] === "object") {
      return { key: TARGET_NAME, item: data[TARGET_NAME] };
    }
    return null;
  }

  async function load(){
    elStatus.textContent = "Veri Ã§ekiliyorâ€¦";
    elValue.textContent = "â€”";
    elDetail.textContent = "â€”";
    elQuip.textContent = "";
    elDebug.textContent = "";

    try{
      const r = await fetch(DATA_URL, { cache:"no-store" });
      if (!r.ok) throw new Error("data.json HTTP " + r.status);
      const d = await r.json();

      const hit = findGramAltin(d);
      if (!hit) throw new Error(`Name='${TARGET_NAME}' bulunamadÄ±`);

      const { key, item } = hit;

      // SatÄ±ÅŸ daha mantÄ±klÄ±; yoksa Buying
      let gram = parseSmart(String(item.Selling ?? item.Buying));
      gram = normalize(gram);

      if (!Number.isFinite(gram)) throw new Error("Fiyat parse edilemedi");

      // ekstra mantÄ±k kontrolÃ¼: gram altÄ±n birkaÃ§ bin TL bandÄ±nda olmalÄ±
      if (gram < 500 || gram > 50000) throw new Error("Fiyat mantÄ±k dÄ±ÅŸÄ±: " + gram);

      const toplam = gram * GRAM_ADET;

      elStatus.textContent = "ArsanÄ±n gÃ¼ncel deÄŸeri (468 g altÄ±n)";
      elValue.textContent  = fmtTRY(toplam);

      const upd = d.Update_Date ? `GÃ¼ncelleme: ${d.Update_Date}` : "";
      const change = (item.Change != null) ? ` â€¢ DeÄŸiÅŸim: ${item.Change}%` : "";
      elDetail.textContent = `1 g = ${fmtTRY(gram)}${change}${upd ? " â€¢ " + upd : ""}`;

      elQuip.textContent = "KÄ±sacasÄ±: â€œ75 bin TLâ€ gÃ¼zel hikÃ¢yeâ€¦ ama bugÃ¼n altÄ±n konuÅŸuyor ğŸ™‚";
      elDebug.innerHTML = `Bulunan kayÄ±t: <code>${key}</code> â€¢ Raw Selling: <code>${item.Selling}</code> â€¢ Raw Buying: <code>${item.Buying}</code>`;
    }catch(e){
      elStatus.textContent = "Veri alÄ±namadÄ±";
      elDetail.textContent = String(e?.message || e);
      elDebug.textContent = "Not: Ctrl+F5 ile cache temizleyip tekrar dene.";
    }
  }

  document.getElementById("refresh").addEventListener("click", load);

  document.getElementById("share").addEventListener("click", () => {
    const msg = "Mehmetâ€™in arsasÄ± â€” 468 gram altÄ±n hesabÄ± (gÃ¼ncel):\n" + location.href;
    window.open("https://wa.me/?text=" + encodeURIComponent(msg), "_blank");
  });

  load();
</script>
</body>
</html>
