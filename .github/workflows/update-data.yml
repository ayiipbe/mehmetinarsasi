name: Update gold price data

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Fetch raw JSON
        run: |
          curl -sL "https://finans.truncgil.com/v4/today.json" -o raw.json

      - name: Build simplified data.json
        run: |
          node - <<'NODE'
          const fs = require("fs");

          const raw = JSON.parse(fs.readFileSync("raw.json", "utf8"));

          function parseTRNumber(x) {
            if (typeof x !== "string") return Number(x);
            // "6.943,53" -> 6943.53
            const cleaned = x.replace(/\./g, "").replace(",", ".");
            const n = Number(cleaned);
            return Number.isFinite(n) ? n : NaN;
          }

          function normalizeGramPrice(p) {
            // gram altın TRY mantıklı band (kabaca) 500 - 50000
            // 436000 gibi ise genelde *100 gelmiştir → /100
            if (!Number.isFinite(p)) return p;
            if (p > 50000) p = p / 100;
            if (p > 50000) p = p / 100; // aşırı uç güvenliği
            return p;
          }

          function pickGram(raw) {
            // 1) direkt anahtar
            const direct = raw["gram-altin"];
            if (direct && (direct.Selling || direct.Buying)) {
              const p = normalizeGramPrice(parseTRNumber(String(direct.Selling || direct.Buying)));
              if (Number.isFinite(p)) return p;
            }

            // 2) içinde "gram" geçen ilk obje
            const entries = Object.entries(raw).filter(([k, v]) =>
              v && typeof v === "object" && (("Selling" in v) || ("Buying" in v))
            );

            const hit = entries.find(([k]) => k.toLowerCase().includes("gram")) || entries[0];
            if (!hit) return NaN;

            const obj = hit[1];
            const p = normalizeGramPrice(parseTRNumber(String(obj.Selling || obj.Buying)));
            return p;
          }

          const price = pickGram(raw);

          // ekstra kontrol: hâlâ saçmaysa NaN bırak (site açıkça hata yazsın)
          const sane = Number.isFinite(price) && price > 500 && price < 50000 ? price : null;

          const out = {
            source: "finans.truncgil.com/v4/today.json",
            updated_at: new Date().toISOString(),
            update_date_raw: raw.Update_Date || null,
            gram_try: sane
          };

          fs.writeFileSync("data.json", JSON.stringify(out, null, 2), "utf8");
          NODE

      - name: Commit if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data.json raw.json
          git commit -m "Update gold data.json" || exit 0
          git push
