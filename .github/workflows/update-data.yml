name: Update gold price data

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Fetch raw JSON
        run: |
          curl -sL "https://finans.truncgil.com/v4/today.json" -o raw.json

      - name: Build simplified data.json
        run: |
          node - <<'NODE'
          const fs = require("fs");

          const raw = JSON.parse(fs.readFileSync("raw.json", "utf8"));

          function parseSmart(x){
            if (typeof x === "number") return x;
            if (typeof x !== "string") return NaN;
            const s = x.trim();
            // "7.067,02" -> 7067.02
            if (s.includes(",")) return Number(s.replace(/\./g,"").replace(",","."));
            // "7067.02" -> 7067.02
            return Number(s);
          }

          function pickGramAltin(raw){
            // 1) raw["gram-altin"] gibi direkt anahtar varsa
            if (raw["gram-altin"] && (raw["gram-altin"].Selling ?? raw["gram-altin"].Buying) != null) {
              return raw["gram-altin"];
            }

            // 2) EN SAĞLAMI: Name === "GRAMALTIN"
            for (const v of Object.values(raw)) {
              if (v && typeof v === "object" && String(v.Name || "").toUpperCase() === "GRAMALTIN") {
                return v;
              }
            }

            return null;
          }

          const item = pickGramAltin(raw);

          let gram = null;
          if (item) {
            // Satış daha mantıklı; yoksa Buying
            gram = parseSmart(String(item.Selling ?? item.Buying));
            if (!Number.isFinite(gram)) gram = null;
          }

          const out = {
            source: "finans.truncgil.com/v4/today.json",
            updated_at: new Date().toISOString(),
            update_date_raw: raw.Update_Date || null,
            gram_try: gram
          };

          fs.writeFileSync("data.json", JSON.stringify(out, null, 2), "utf8");
          NODE


      - name: Commit if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data.json raw.json
          git commit -m "Update gold data.json" || exit 0
          git push
